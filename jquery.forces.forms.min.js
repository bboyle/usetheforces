/*
 * usetheforces
 * @see http://usetheforces.googlecode.com/
 * @license GNU GENERAL PUBLIC LICENSE Version 3 <http://www.gnu.org/licenses/gpl.html>
 * @requires jQuery
 */
if(typeof(jQuery)!="undefined"){(function(c){var a=c.forces=c.forces||{};var f="January February March April May June July August September October November December".split(/ /);var e="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(/ /);var b=new Date();var d=function(h,g,i){h=String(h);while(h.length<g){h=String(i)+h}return h};a.dateFormat=function(g,h){if(!g){return""}if(!h){return g.toString()}return h.replace(/YYYY|yyyy|%Y/,g.getFullYear()).replace(/MM|%m/,d(g.getMonth()+1,2,"0")).replace(/dd|%d/,d(g.getDate(),2,"0")).replace(/%e/,d(g.getDate(),2," ")).replace(/d/,g.getDate()).replace(/%B/,f[g.getMonth()]).replace(/%A/,e[g.getDay()])};a.dateParse=function(p,j,m){p=p.split(/[^A-Za-z0-9]/);var g=j||m||b;var h={};function n(q,i){h[q]=h[q]||i}for(var k=0;k<p.length;k++){if(p[k].match(/^\d{4}$/)){n("year",p[k])}else{if(p[k].match(/^\d{1,2}$/)){var o=h.date?(h.month?"year":"month"):"date";if(o=="year"&&!h.year){p[k]=(g.getFullYear()+"").substring(0,2)+d(p[k],2,"0");if(j&&j.getFullYear()>p[k]){p[k]+=100}else{if(m&&m.getFullYear()<p[k]){p[k]-=100}else{if(!j&&!m&&p[k]>g.getFullYear()+20){p[k]-=100}}}}n(o,p[k])}}}if(h.date&&h.month&&h.year){var l=new Date(h.year,h.month-1,h.date);if(a.dateEquals(l,h.year,h.month,h.date)){return l}}return null};a.dateCalc=function(g,h){return new Date(g.getFullYear()+(h.year||0),g.getMonth()+(h.month||0),g.getDate()+(h.date||0))};a.dateEquals=function(h,j,g,i){return(h.getMonth()==g-1&&h.getDate()==i&&h.getFullYear()==j)};a.DATE_TODAY=function(){return new Date(b.getFullYear(),b.getMonth(),b.getDate())}})(jQuery)}if(typeof(jQuery)!="undefined"){(function(z){var s=z.forces=z.forces||{};s.triggerChangeOnInput=false;var e="must be completed";var o="violates max constraint";var E="violates min constraint";var l="unrecognised date format";var B="must be a number";var b="January February March April May June July August September October November December".split(/ /);var C="Sunday Monday Tuesday Wednesday Thursday Friday Saturday".split(/ /);var g="Unable to submit form";var H=2000;var G=true;var j="xf-alert";var w="xf-invalid";var k="xf-valid";var r="xf-required";var u="xf-submit-error";var K="-xf-enabled";var m="-xf-disabled";var f="-xf-required";var I="-xf-optional";var v="-xf-value-changed";var i="-tf-attr-";var a="-tf-calc-";var F="-xf-constraints";var n="-xf-constraints-min";var D="-xf-constraints-max";var c="-tf-depend-c";var x="-tf-depdend-v";var J="-xf-disabled";var p="-xf-valid";var q="-tf-value";var A="-tf-submit-alert";var y="-tf-format-date-output";var t="-tf-format-date-submit";var h="-tf-submit-time";z.extend(z.expr[":"],{"-tf-blank":function(M){var L=z(M).xfValue();return L==null||z.trim(L).length==0},"-tf-date":function(L){return z(L).data(t)!=null},"-tf-number":function(L){return z(L).hasClass("number")},"-xf-alert":function(L){return z(L).hasClass(j)},"-xf-control":function(L){return z(L).is(".xf-input,.xf-select1,.xf-select,.xf-secret,.xf-textarea,.xf-group")},"-xf-group":function(L){return z(L).hasClass("xf-group")},"-xf-hint":function(L){return z(L).hasClass("xf-hint")},"-xf-input":function(L){return z(L).hasClass("xf-input")},"-xf-invalid":function(L){return z(L).data(p)===false},"-xf-label":function(L){return z(L).hasClass("xf-label")},"-xf-output":function(L){return z(L).hasClass("xf-output")},"-xf-relevant":function(L){return z(L).find("input:enabled,select:enabled,textarea:enabled").length>0},"-xf-required":function(L){L=z(L);return L.find(".required").size()>0},"-xf-secret":function(L){return z(L).hasClass("xf-secret")},"-xf-select":function(L){return z(L).hasClass("xf-select")},"-xf-select1":function(L){return z(L).hasClass("xf-select1")},"-xf-textarea":function(L){return z(L).hasClass("xf-textarea")},"-xf-valid":function(L){return z(L).data(p)===true}});var d={pad:function(M,L,N){M=String(M);while(M.length<L){M=String(N)+M}return M},xpath2js:function(L){return L.replace(/ and /g," && ").replace(/ or /," || ").replace(/ = /g," == ")},regexNamesXpath:/(?:^|\s+|\()([_A-Za-z][_A-Za-z0-9.]*)(?:\)|\s+|$)/g};z.forces_frag=function(L){window.location.hash=L};z.forces_validate=function(L){G=(L==true)};z.fn.forces_attr=function(M,S){switch(M){case"relevant":case"required":if(S!==undefined){var T=this.forces_xform_control();T.data(i+M,S);S=d.xpath2js(S);var R={};var Q;while(Q=d.regexNamesXpath.exec(S)){if(R[Q[1]]===undefined){var L=z.forces_form_field(Q[1]);L.data(c,T.add(L.data(c)));R[Q[1]]=L}}Q="";var O=1;for(var N in R){Q+="var v"+O+'=$.forces_val("'+N+'");';S=S.replace(new RegExp(N,"g"),"v"+O);O++}var P=new Function(Q+"return "+S+";");T.data(a+M,P).forces_recalculate();return this}else{return this.forces_xform_control().data(i+M)}break;default:return this.attr(M,S)}};z.fn.forces_removeAttr=function(L){switch(L){case"relevant":case"required":this.forces_xform_control().removeData(i+L).removeData(a+L);return this}return this.removeAttr(L)};z.fn.constraint=function(L,O,P){var N=this.xForm();function M(Q,R,S){if(N.data(F)==null){N.data(F,[])}N.data(F).push({selector:Q,alertMessage:R,test:S})}if(P==null){this.each(function(){var Q=z(this);Q=Q.attr("id")||Q.forces_xform_control().find("*[id]").attr("id");M("#"+Q,L,O)})}else{M(L,O,P)}return this};z.fn.form=function(){return this.is("form")?this:this.parents("form")};z.fn.forces_form_dateField=function(N,O,M,L){N=N||"YYYY-MM-dd";return this.forces_xform_control().filter(function(){var T=z(this);var Q=T.xfValueAsDate();var R=T.find(":text");if(R.length==1){R=R.eq(0);var S=z('<input type="hidden" name="'+R.attr("name")+'" />');S.val(s.dateFormat(Q,N));R.eq(0).after(S).removeAttr("name");T.data(t,N).data(n,M||null).data(D,L||null);if(O){var P=z('<span class="xf-output"></span>');if(R.val()){P.text(s.dateFormat(Q,O))}R.after(P);T.data(y,O)}else{T.removeData(y)}return true}return false})};z.forces_form_field=function(L){if(typeof(L)=="string"){L=L.charAt(0)=="#"?z(L):z('*[name="'+L+'"]').eq(0)}return L.forces_xform_control()};z.forces_val=function(L){return z.forces_form_field(L).xfValue()};z.fn.forces_label=function(L,M){this.each(function(){var O=z(this);if(L){if(M==null){var N=new RegExp("([:?]+)$").exec(O.text());M=N?N[1]:""}O.html(L+M)}});return this};z.fn.forces_recalculate=function(){var M,L;return this.each(function(){M=z(this);if(L=M.data(a+"relevant")){L=L();if(L!=M.is(":-xf-relevant")){if(L){M.trigger(K)}else{M.trigger(m)}}}if(L=M.data(a+"required")){L=L();if(L!=M.is(":-xf-required")){if(L){M.trigger(f)}else{M.trigger(I)}}}})};z.fn.forces_xform_control=function(){return this.map(function(){var L=z(this);return(L.is(":-xf-control")?L:L.parents(":-xf-control")).get(0)})};z.fn.useForcesValidation=function(L){var M=z(this).xForm();if(L){M.data(A,L);return true}else{if(L===false){M.removeData(A);return false}}return M.data(A)!=null};z.fn.validate=function(){function L(O,N,M){O.data(p,N);if(N){O.find(":-xf-alert").remove();O.removeClass(w).addClass(k)}else{O.removeClass(k).addClass(w).find(":-xf-label").eq(0).parent().find(":-xf-alert").remove().end().append('<em class="'+j+'">'+M+"</em>")}return N}return this.forces_xform_control().filter(function(){var R=z(this);if(!R.is(":-xf-group")&&R.is(":-tf-blank")){if(R.is(":-xf-required")){return L(R,false,e)}else{return L(R,true)}}else{var P=R.data(n)||null;var M=R.data(D)||null;if(R.is(":-tf-number")){var Q=R.xfValue();if(Q.match(/[^0-9,.$]/)){return L(R,false,B)}}else{if(R.is(":-tf-date")){var N=R.xfValueAsDate();if(!N){return L(R,false,l)}if(P&&N<P){return L(R,false,E)}if(M&&N>M){return L(R,false,o)}}}var S=R.data(F)||[];for(var O=0;O<S.length;O++){if(!S[O].test(R)){return L(R,false,S[O].alertMessage)}}S=R.xForm().data(F)||[];for(O=0;O<S.length;O++){if(R.is(S[O].selector)&&!S[O].test(R)){return L(R,false,S[O].alertMessage)}}}return L(R,true)})};z.fn.xfAlert=function(){return this.forces_xform_control().find(":-xf-alert").eq(0).text()};z.fn.xForm=function(){return this.hasClass("xform")?this:this.parents(".xform")};z.fn.xfValue=function(){if(this.find(":radio").length){var L=this.find(":radio:checked");return L.length>0?L.val():null}else{if(this.find(":checkbox").length){var L=this.find(":checkbox:checked");return L.length>0?L.val():null}}return this.find("input,select,textarea").eq(0).val()};z.fn.xfValueAsDate=function(){var L=this.xfValue();if(L){return s.dateParse(this.xfValue(),this.data(n),this.data(D))}};z(document).bind(m,function(L){z(L.target).data(J,true).stop(true,true).hide().find("input,select,textarea").attr("disabled","disabled")}).bind(K,function(L){z(L.target).removeData(J).find("input,select,textarea").removeAttr("disabled").end().stop(true,true).slideDown(300)}).bind(f,function(L){z(L.target).addClass(r).find(".xf-label").eq(0).after('<abbr title="required" class="required">*</abbr>')}).bind(I,function(L){z(L.target).removeClass(r).find("abbr.required").remove()});z("form").bind(v,function(L,N){if(N.is(":-tf-date")){var M=N.xfValueAsDate();N.find("input:hidden").val(s.dateFormat(M,N.data(t)));if(N.data(y)){N.find(":-xf-output").text(s.dateFormat(M,N.data(y)))}}N.add(N.data(x)).validate();if(N.data(c)){N.data(c).forces_recalculate()}}).bind("submit",function(N){var P=new Date().getTime();var L=z(N.target).xForm();function R(S){S.addClass(u);return false}if(L.data(h)&&P-L.data(h)<H){return false}L.data(h,P);var O=z(":-xf-control:-xf-relevant",L);O.validate();var Q=O.filter(":-xf-invalid");if(G&&Q.length>0){var M=L.prev(".status");if(M.length==1){M.find("li").remove()}else{M=z('<div id="status" class="status alert"><h1>'+(L.data(A)||g)+"</h1><ol></ol></div>")}Q.each(function(){var S=z(this);M.find("ol").append(z('<li><a href="#'+S.find("*[id]").attr("id")+'">'+S.find(":-xf-label").eq(0).text().replace(/([:?]*)$/,": ")+S.xfAlert()+"</a></li>"))});L.before(M);z.forces_frag(M.attr("id"));return R(L)}return true});z("input,select,textarea").change(function(L){var M=z(L.target).forces_xform_control();M.form().trigger(v,[M])});z(":text,:password,textarea").keyup(function(L){if(!s.triggerChangeOnInput){return}var M=z(L.target);var N=M.val();M=M.forces_xform_control();if(M.data(q)!=N){M.data(q,N);M.form().trigger(v,[M])}});if(z.browser.msie||z.browser.opera){z(":radio,:checkbox").click(function(L){var M=z(L.target).forces_xform_control();var N=M.xfValue();if(M.data(q)!=N){M.data(q,N);M.form().trigger(v,[M])}})}})(jQuery)};